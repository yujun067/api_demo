version: "3.8"

x-common-env: &common-env
  REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
  DATABASE_URL: sqlite:////app/data/hacker_news.db
  HACKER_NEWS_API_BASE_URL: ${HACKER_NEWS_API_BASE_URL:-https://hacker-news.firebaseio.com/v0}
  FETCH_INTERVAL_MINUTES: ${FETCH_INTERVAL_MINUTES:-30}
  CACHE_TTL_SECONDS: ${CACHE_TTL_SECONDS:-300}
  MAX_CONCURRENT_REQUESTS: ${MAX_CONCURRENT_REQUESTS:-10}
  CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://redis:6379/0}
  CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND:-redis://redis:6379/0}
  LOG_LEVEL: ${LOG_LEVEL:-INFO}

x-common-volumes: &common-volumes
  - ./data:/app/data

services:
  redis:
    image: redis:7-alpine
    container_name: hn-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  web:
    build: .
    container_name: hn-web
    ports:
      - "${WEB_PORT:-8000}:8000"
    environment: *common-env
    volumes: *common-volumes
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/detailed"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  # Background task processing services
  worker:
    build: .
    container_name: hn-worker
    command: celery -A app.tasks.celery_app worker --loglevel=${LOG_LEVEL:-info} --concurrency=2
    environment: *common-env
    volumes: *common-volumes
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "celery", "-A", "app.tasks.celery_app", "inspect", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  scheduler:
    build: .
    container_name: hn-scheduler
    command: celery -A app.tasks.celery_app beat --loglevel=${LOG_LEVEL:-info}
    environment: *common-env
    volumes: *common-volumes
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  flower:
    build: .
    container_name: hn-flower
    command: celery -A app.tasks.celery_app flower --port=5555 --broker=${CELERY_BROKER_URL}
    ports:
      - "${FLOWER_PORT:-5555}:5555"
    environment: *common-env
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5555/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - monitoring

  # Test service for running tests in containerized environment
  test:
    build: .
    container_name: hn-test
    command: ["/bin/bash", "-c", "chmod +x run_tests.sh && ./run_tests.sh"]
    environment: *common-env
    volumes: *common-volumes
    depends_on:
      redis:
        condition: service_healthy
    profiles:
      - test

volumes:
  redis_data:
    driver: local

networks:
  default:
    name: hacker-news-network
